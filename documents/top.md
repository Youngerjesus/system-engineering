# top 을 통해서 살펴보는 프로세스 정보들 

top 명령을 통해서 시스템 정보를 가장 빠르게 살펴볼 수 있다.

## 시스템 상태 살펴보기

top 은 cpu, memory, swap, process 등의 정보를 준다.

나오는 정보는 다음과 같다.

- 현재 서버의 시간과 서버가 얼마나 구동되었는지
- 몇명의 사용자가 로그인해 있는지
- 시스템의 Load Average 는 어느정도 인지 (Load Average 는 이후에 설명하겠다. 간략하게만 말하면 이 수치가 높으면 서버가 많은 일을 하고 있다고 생각하면 된다.)
- 현재 구동중인 프로세스와 관련 정보들 (CPU 사욜량, 프로세스 우선순위, 프로세스 상태, 메모리)
- 총 메모리 사용량과 스왑 영역 사용량 등이 있다.

top 을 입력하면 기본적으로 3 초 간격으로 갱신해서 보여준다. 이를 원하지 않는다면 `-b` 옵션을 주자.

## VIRT, RES, SHR?

프로세스와 관련된 항목 중에 VIRT, RES, SHR 은 메모리와 관련된 부분이다.

VIRT 는 Virtual Memory 의 전체 용량을 가리키고

RES 는 현재 프로세스가 사용하고 있는 실제 메모리를 가리킨다.

SHR 는 다른 프로세스와 공유하고 있는 메모리를 나타낸다. (리눅스 프로세스의 경우 공통으로 사용하는 라이브러리 같은게 이 메모리 영역이 될 수 있다.)

VIRT 는 가상으로 잡아놓은 거고 실제 메모리에 할당은 하지 않았던 것이다. 그러므로 메모리를 많이 점유하고 있는 프로세스를 찾고 있다면 RES 가 높은 프로세스를 찾자.

추가) RES 가 부족하면 어떻게 될까? 스왑영역의 메모리를 사용하거나 OOM (out-of-memory) Killer 로 프로세스를 죽여서 메모리를 확보할 것이다. 

## VIRT 와 RES 그리고 memory commit 

malloc() 과 같은 메모리 할당을 호출하는 시스템 콜을 필요로 하는 함수를 호출한다면 RES 가 높아질 것이라고 생각하지만 그렇지 않다. VIRT 만 올라간다.

실제로 메모리에 쓰기 작업이 일어나는 시점에 메모리가 할당되고 RES 가 올라갈 것이다.

- 쓰기 작업을 했을 때 Page Fault 가 일어나고 그제서야 메모리를 할당한다. 이런 정보는 커널 내의 전역변수인 Page Table 에서 모두 관리한다. 

이 이유는 Memory Commit 이라는 동작 방식 때문인데 이는 실제로 필요한 시점에 메모리 작업을 하도록하는 지연 연산이다.

이런 동작 방식을 통해서 COW (copy-on-write) 라는 기법을 사용할 수 있다. 

`sar` 이라는 모니터링 툴을 통해서 Memory Commit 의 비율을 알 수 있다. 

이 비율이 높다면 순간적으로 메모리 쓰기 요청이 들어왔을 때 메모리를 할당해야 하니 문제가 생길 수 있다.

## 프로세스의 상태 보기 

`top` 을 통해서 프로세스의 상태를 볼 수 있다고 했다. 

프로세스의 상태는 다음과 같다.

- `S`: sleeping
- `D`: Uninterruptible sleep
- `R`: running
- `T`: traced or stopped
- `Z`: zombie

D 는 디스크 혹은 네트워크 I/O 가 걸려있는 상태다. 여기에 있는 프로세스는 Run Queue 에서 나와서 Wait Queue 에 들어가게 된다.
실제로 이 상태의 프로세스가 많다면 개선해야 할 문제다. (Reactive Programming 을 사용해야 할 듯.)

R 는 실행 중인 프로세스로 실제로 CPU 를 먹고 있는 상태다.

S 는 D 와 유사하지만 시그널을 주면 언제든지 실행할 수 있다.

T 는 trace 등으로 프로세스의 시스템 콜을 추적하고 있는 상태다.

Z 는 좀비 프로세스로 부모 프로세스에 의해서 회수되지 못한 자식 프로세스가 남겨져 있는 상태다. 좀비 프로세스의 문제는 적은 리소스를 메모리에서 계속 가지고 있는 문제와 PID 를 점유하고 있는 문제가 있다. 
    
## 프로세스의 우선순위

`top` 을 통해서 볼 수 있는 항목 중 프로세스의 우선순위와 관련있는 값은 `PR` 과 `NI` 이다.

PR 은 프로세스의 우선순위 값을 나타내는 것으로 낮을수록 우선순위가 높다.

NI 는 우선순위에 영향을 주는 가산점이라고 생각하면 된다.