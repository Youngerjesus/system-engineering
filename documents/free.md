# free 명령이 숨기고 있는 것들

메모리가 부족하다면 프로세스는 더 이상 작업을 할 수 없고 이는 시스템 장애나 응답 속도가 느려지는 현상을 일으킬 수 있다.

그렇기 때문에 메모리가 어떻게 사용되고 있는지를 파악하는 것은 CPU 사용률과 Load Average 만큼 중요한 포인트다.

여기서는 메모리 상태를 볼 수 있는 `free` 명령어와 `free` 만으로 살펴볼 수 없는 정보는 어떻게 볼 수 있는지 살펴보겠다.

## 메모리 사용량 확인하기

free 명령을 사용하면 다음과 같은 것들이 출력된다.

여기서 `-m` 옵션을 주면 MB 단위로 표시된다.

- `total`: 현재 시스템에 설치되어있는 전체 메모리양을 의미한다.
- `used`: 시스템에서 사용하고 있는 메모리양을 의미한다. 
- `free`: 시스템에서 아직 사용하고 있지 않은 메모리 양을 의미한다. 그러므로 애플리케이션이 사용할 수도, 커널이 사용할 수도 있다.
- `shared`: 프로세스 사이에 공유하고 있는 메모리양이다. 
- `buffred`: 버퍼 용도로 사용하고 있는 메모리 영역을 말하며 시스템의 성능 향상을 위해서 커널에서 사용하고 있는 영역이다.
- `cached`: 페이지 캐시라고 불리는 캐시 영역에 있는 메모리양을 의미한다. 페이지 캐시는 디스크 블록을 캐싱해놓음으로써 I/O 작업의 성능향상을 위해서 사용된다.
- `-/+ buffers/cached`: 메모리 사용량에서 bufferd 와 cached 를 제외하고, 사용하고 있는 영역과 사용하지 않는 영역을 표시해준다. 
- `Swap`: Swap 의 전체 영역과 실제로 사용하고 있는 영역 그리고 사용하지 않은 영역을 표시해준다.

## Buffers 와 cached 영역

커널이 블록 디바이스에서 데이터를 읽어올 때, 즉 파일을 읽어올 때는 Page cache 인 cached 영역을 사용하고

파일의 내용이 아닌 파일 시스템을 관리하기 위한 메타 데이터를 읽어올 때는 Buffer 영역을 사용한다.

그리고 이전에 메모리에서 buffer 과 cached 영역을 제외하고 보여주는 부분이 있는데 이 이유는 이 영역의 경우에는 프로세스가 메모리를 더 필요로 하는 경우에 언제든지 해제될 수 있는 영역이기 때문이다. 

## /proc/meminfo 읽기

free 보다 좀 더 자세하게 메모리 상태를 보고 싶다면 /proc/meminfo 를 통해서 확인하자.

여기서 제공하는 추가적인 정보는 다음과 같다.

- `SwapCached`: swap 으로 빠진 메모리 영역 중 다시 메모리로 돌아온 영역을 말한다. swap 으로 한번 메모리가 빠졌으면 다시 swap 이 될 가능성이 많아서 swap 영역에 있는 메모리는 삭제되지 않는다. 이를 통해 I/O 를 조금이나마 줄일 수 있다.
- `Active(anon)`: anon 은 anonymous 로 Page cache 영역을 제외한 메모리 영역을 말한다. active 는 최근까지 메모리를 사용하고 있어서 swap 영역으로 넘어가지 않는 영역을 뜻한다.
- `inactive(anon)`: swap 영역으로 넘어갈 수 있는 anon 영역을 말한다.
- `Active(file)`: buffers 와 cached 영역을 포함한 영역이고 active 이므로 최근에 참조해서 swap 영역으로 넘어가지 않는다.
- `inactive(file)`: swap 영역으로 넘어갈 수 있는 buffers 와 cached 영역을 말한다.
- `Dirty`: I/O 성능 향상을 위ㅐ 커널이 캐시 목적으로 사용하는 영역 중에 쓰기 작업의 영역을 말한다. 커널은 I/O 작업으로 쓸 때 바로 쓰지 않고 이 영역에 모아서 쓴다.

여기서 active, inactive 라는 말이 나왔는데 스왑영역으로 넘어가느냐 안넘어가느냐는 LRU 캐시 방식에 의해서 이뤄진다.

## slab 메모리 영역

/proc/meminfo 에서 아직 설명하지 않은 영역이 있는데 slab 영역들이다.

이 영역들은 커널이 내부적으로 사용하는 영역을 뜻한다.

주로 I/O 작업을 더 빠르게 하기 위해서 inode cache, dentry cache 등에  사용하거나 네트워크 소켓을 위한 메모리 영역을 확보하는 작업들을 한다.

inode_cache 는 파일의 inode 에 대한 정보를 지정해두는 캐시라면 dentry 는 디렉터리의 계층 관계를 저장해두는 캐시다.

즉 dentry 는 ls 명령으로 디렉터리를 살펴보기만 해도 값이 증가한다. 만약 파일에 자주 접근하고 디렉터리의 생성/삭제가 빈번한 시스템이라면 Slab 메모리가 늘어날 수 있다.

하나씩 살펴보면 다음과 같다.

- `Slab`: 메모리 영역 중 커널이 직접 사용하고 있는 영역을 말한다. 
- `SReclaimable`: Slab 영역 중 캐시용도로 사용하고 있는 영역이며 메모리 부족 현상이 일어나면 프로세스에게 할당될 수 있는 영역이다.
- `SUnreclaim`: 커널이 현재 사용중인 영역을 말하며 해제할 수 없는 영역이다.

그리고 `slabtop` 을 쓰면 현재 시스템에서 사용중인 `Slab` 영역을 볼 수 있다.

Slab 메모리는 buffers/cached 영역에 포함되지 않고 free 명령으로 조회했을 때 used 에 포함된다. 
